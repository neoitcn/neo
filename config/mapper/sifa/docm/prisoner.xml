<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
	"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.aofa.sifa.mapper.docm.PrisonerDao">
	
	<sql id="prisonerColumns">
		p.id,
		p.no,
		p.name,
		p.phone,
		p.sex,
		p.password,
		p.identify_type,
		p.id_card,
		p.imei,
		p.photo_Id,
		p.FZLX,
		p.JTZM,
		p.mz,
		p.edu_background,
		p.correct_office,
		p.correct_type,
		p.office_id,
		p.ismove,
		p.criminal_type,
		p.corr_type,
		p.birthday,
		p.orig_sentence,
		p.home_addr,
		p.admin_time,
		p.begin_time,
		p.end_time,
		p.remarks,
		p.creater_id,
		p.create_time,
		p.update_id,
		p.update_time,
		p.deleted,
		p.enabled_audit,
		p.monitor_area_id,
		p.online
	</sql>
	<sql id="prisonerColumns2">
		id,
		no,
		name,
		phone,
		sex,
		identify_type,
		id_card,
		password,
		imei,
		photo_Id,
		FZLX,
		JTZM,
		mz,
		edu_background,
		correct_office,
		correct_type,
		office_id,
		criminal_type,		
		corr_type,
		birthday,
		orig_sentence,
		home_addr,
		admin_time,
		begin_time,
		end_time,
		remarks,
		creater_id,
		create_time,
		update_id,
		update_time,
		deleted,
		enabled_audit,
		monitor_area_id
	</sql>
	<resultMap type="Prisoner" id="prisoner" extends="baseBean">
		<id column="id" property="id"/>
		<result column="no" property="no"/>
		<result column="name" property="name"/>
		<result column="phone" property="phone"/>
		<result column="sex" property="sex"/>
		<result column="password" property="password"/>	
		<result column="identify_type" property="identifyType"/>
		<result column="id_card" property="idCard"/>
		<result column="imei" property="imei"/>
		<result column="photo_Id" property="photoId"/>		
		<result column="FZLX" property="fzlx"/>
		<result column="JTZM" property="jtzm"/>
		<result column="mz" property="mz"/>
		<result column="edu_background" property="eduBackground"/>
		<result column="correct_office" property="correctOffice"/>
		<result column="correct_type" property="correctType"/>
		<result column="office_id" property="officeId"/>
		<result column="ismove" property="isMove"/>
		<result column="criminal_type" property="criminalType"/>
		<result column="birthday" property="birthday"/>
		<result column="orig_sentence" property="origSentence"/>
		<result column="corr_type" property="corrType"/>
		<result column="home_addr" property="homeAddr"/>
		<result column="admin_time" property="adminTime"/>
		<result column="begin_time" property="beginTime"/>
		<result column="end_time" property="endTime"/>
		<result column="remarks" property="remarks"/>
		<result column="office_name" property="officeName"/>
		<result property="enabledAudit" column="enabled_audit" />
		<result property="monitorAreaId" column="monitor_area_id" />
		<result property="online" column="online" />
	</resultMap>
	<resultMap type="BaseBean" id="baseBean">
		<result column="creater_id" property="createrId"/>
		<result column="create_time" property="createTime"/>
		<result column="update_id" property="updateId"/>
		<result column="update_time" property="updateTime"/>
		<result property="deleted" column="deleted" />		
	</resultMap>
	
	<select id="getPrisoners" resultMap="prisoner">
		select 
			<include refid="prisonerColumns"></include>
			,f.name as office_name,f.code as officeCode
		<if test="needGemo == 'true'">
			,h.address,h.posttime
		</if>
		from fm_prisoner p
		<if test="needGemo == 'true'">
			left join (select id,max(posttime),id_card from mo_history_info group by id_card) m on m.id_card = p.id_card
			left join mo_history_info h on h.id = m.id
		</if>
		left join sys_office f on  p.office_id=f.id and f.enabled = 1 and f.deleted = 1
		where p.deleted=1 and p.enabled_audit = 1 and p.ismove=1
		<if test="name!=null and name!=''">
			 and ( p.name like concat('%',#{name},'%') or phone like concat('%',#{name},'%') ) 
		</if>
		<if test="officeName!=null and officeName!=''">
			and f.name like concat('%',#{officeName},'%')
		</if>
		<if test="sex!=null and sex!=-1">
			and p.sex=#{sex}
		</if>
		<if test="criminalType !=null and criminalType!=''">
			and p.criminal_type like concat('%',#{criminalType},'%')
		</if>
		<if test="origSentence !=null and origSentence!=''">
			and p.orig_sentence like concat('%',#{origSentence},'%')
		</if>
		<if test="corrType !=null and corrType!=''">
			and p.corr_type like concat('%',#{corrType},'%')
		</if>
		<if test="admin == null or admin != 1">
			and p.office_id in
			<foreach collection="ids" open="(" close=")" separator="," item="id">
				#{id}
			</foreach>
		</if>
		order by p.create_time	
		<if test="rows > 0">
			limit #{start},#{rows}
		</if>
	</select>

	<select id="getPageNum" resultType="java.lang.Long">	
	select count(1) from fm_prisoner where fm_prisoner.create_time&lt;=(
	select p.create_time from fm_prisoner  p left join sys_office f on  p.office_id=f.id and f.enabled = 1 and f.deleted = 1
	where p.deleted=1 and p.enabled_audit = 1 
	and p.ismove=1
	<if test="locatePrisonerId!=null and locatePrisonerId!=''">
		and	 p.id=#{locatePrisonerId}
	</if>
	)
	order by fm_prisoner.create_time		
	</select>
	
	<select id="getCount" resultType="java.lang.Long">
		select 
			count(p.id)
		from fm_prisoner p
		left join sys_office f on  p.office_id=f.id and f.enabled = 1 and f.deleted = 1
		where p.deleted=1 and p.enabled_audit = 1 and p.ismove=1
		<if test="name!=null and name!=''">
			 and ( f.name like concat('%',#{name},'%') or p.phone like concat('%',#{name},'%') ) 
		</if>
		<if test="officeName!=null and officeName!=''">
			and p.name like concat('%',#{officeName},'%')
		</if>
		<if test="sex!=null and sex!=-1">
			and p.sex=#{sex}
		</if>
		<if test="criminalType !=null and criminalType!=''">
			and p.criminal_type like concat('%',#{criminalType},'%')
		</if>
		<if test="origSentence !=null and origSentence!=''">
			and p.orig_sentence like concat('%',#{origSentence},'%')
		</if>
		<if test="corrType !=null and corrType!=''">
			and p.corr_type like concat('%',#{corrType},'%')
		</if>
		<if test="admin == null or admin != 1">
			and p.office_id in
			<foreach collection="ids" open="(" close=")" separator="," item="id">
				#{id}
			</foreach>
		</if>
	</select>
	<select id="getPrisonerById" resultMap="prisoner">
		select 
			<include refid="prisonerColumns"></include>
		from fm_prisoner p where p.deleted=1 and p.id=#{id}
	</select>
	<select id="getPrisonerByNo" resultMap="prisoner">
		select 
			<include refid="prisonerColumns"></include>
		from fm_prisoner p where p.deleted=1 and p.no=#{no}
	</select>
	<select id="getPrisonerByIdCard" resultMap="prisoner">
		select 
			<include refid="prisonerColumns"></include>,f.name as office_name,f.code as officeCode
		from fm_prisoner p 
		left join sys_office f on  p.office_id=f.id and f.enabled = 1 and f.deleted = 1
		where p.deleted=1 and p.id_card=#{idCard}
	</select>
	
	<select id="getPrisonerByOffice" resultMap="prisoner">
		select 
			<include refid="prisonerColumns"></include>
		from fm_prisoner p where p.deleted=1 and p.office_id in (${officeId}) and p.enabled_audit =1 and p.ismove =1
	</select>
	<select id="checkPrisoner" resultMap="prisoner">
		select <include refid="prisonerColumns"></include>
		from fm_prisoner p
		where p.deleted = 1
		<if test="selfId != null and selfId != ''">
			and p.id != #{selfId}
		</if>
		<choose>
			<when test="(phone != null and phone != '') or (idCard != null and idCard != '') or (imei != null and imei != '')">
				and( 1=2 
				<if test="phone != null and phone != ''">
					or p.phone = #{phone}
				</if>
				<if test="idCard != null and idCard != ''">
					or p.id_card = #{idCard}
				</if>
				<if test="imei != null and imei != ''">
					or p.imei = #{imei}
				</if>
				)
			</when>
			<otherwise>
				and 1=2
			</otherwise>
		</choose>
	</select>
	<insert id="addPrisoner">
		insert into fm_prisoner (
			<include refid="prisonerColumns2" />
		) values(
			#{id},
			#{no},
			#{name},
			#{phone},
			#{sex},
			#{identifyType},
			#{idCard},
			#{password},
			#{imei},
			#{photoId},
			#{fzlx},
			#{jtzm},
			#{mz},
			#{eduBackground},
			#{correctOffice},
			#{correctType},
			#{officeId},
			#{criminalType},
			#{corrType},
			#{birthday,jdbcType=TIMESTAMP},
			#{origSentence},
			#{homeAddr},
			#{adminTime,jdbcType=TIMESTAMP},
			#{beginTime,jdbcType=TIMESTAMP},
			#{endTime,jdbcType=TIMESTAMP},
			#{remarks},
			#{createrId},
			#{createTime,jdbcType=TIMESTAMP},
			#{updateId},
			#{updateTime,jdbcType=TIMESTAMP},
			#{deleted},
			#{enabledAudit},
			#{monitorAreaId}
		)
	</insert>
	<update id="updatePrisoner" >
		update fm_prisoner set
		<!-- 矫正人员编号要自动生成，不允许修改 -->
			<!-- no=#{no}, -->
			name=#{name},
			phone=#{phone},
			sex=#{sex},
			password=#{password},
			imei=#{imei},
			photo_Id=#{photoId},
			FZLX=#{fzlx},
			JTZM=#{jtzm},
			mz=#{mz},
			edu_background=#{eduBackground}, 
			correct_office=#{correctOffice},
			correct_type=#{correctType},
			identify_type=#{identifyType},
			id_card=#{idCard},
			office_id=#{officeId},
			criminal_type=#{criminalType},
			corr_type=#{corrType},
			birthday=#{birthday,jdbcType=TIMESTAMP},
			orig_sentence=#{origSentence},
			home_addr=#{homeAddr},
			admin_time=#{adminTime,jdbcType=TIMESTAMP},
			begin_time=#{beginTime,jdbcType=TIMESTAMP},
			end_time=#{endTime,jdbcType=TIMESTAMP},
			remarks=#{remarks},
			update_id=#{updateId},
			update_time=#{updateTime,jdbcType=TIMESTAMP},
			deleted=#{deleted},
			ismove=#{isMove},
			pre_office_id=#{preOfficeId},
			monitor_area_id=#{monitorAreaId}
		where id = #{id}
	</update>
	<update id="deletePrisoner">
		update fm_prisoner set deleted=0 where id=#{id}
	</update>
	<update id="setArea">
		update fm_prisoner
		set
		monitor_area_id = #{monitorAreaId}
		where id=#{id}
	</update>
	<!-- 临时的方法，设置在线状态以后要移入到redis。 -->
	<update id="setOnline">
		update fm_prisoner
		set
		online = #{online}
		where id=#{id} or id_card = #{id}
	</update>
</mapper>