<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.aofa.sifa.mapper.information.MeetingInfoDao">
 <sql id="meetingInfoColumns">
    m.id,m.bm, m.phone, m.name, m.address, m.posttime, m.varyvat, m.varylon,m.gemo,m.idCard,m.office_id,m.bname 
  </sql>
 <sql id="meetingInfoColumns2">
     id,bm, phone, name, address, posttime, varyvat, varylon,gemo,idCard,office_id,bname
  </sql>
  <resultMap id="meetingInfoMap" type="MeetingInfo">
     <id column="id" jdbcType="VARCHAR" property="id" />
    <result column="bm" jdbcType="VARCHAR" property="bm" />
    <result column="phone" jdbcType="VARCHAR" property="phone" />
    <result column="name" jdbcType="VARCHAR" property="name" />
    <result column="address" jdbcType="VARCHAR" property="address" />
    <result column="posttime" jdbcType="TIMESTAMP" property="posttime" />
    <result column="varyvat" jdbcType="VARCHAR" property="varyvat" />
    <result column="varylon" jdbcType="VARCHAR" property="varylon" />
    <result column="idCard" jdbcType="VARCHAR" property="idCard" />
     <result column="office_id" jdbcType="INTEGER" property="officeId" />
     <result column="bname" jdbcType="VARCHAR" property="bname" />
  </resultMap>
  <select id="getCount" resultType="java.lang.Long">
  	select count(id) from mo_meeting_info m
  	where 1= '1'  
   	<if test="name!=null and name!=''">
			 and (m.NAME like concat('%',#{name},'%') or m.phone = #{name})			 
	</if>
  	<if test="idCard != null and idCard != ''">
  		and m.id_card = #{idCard}
  	</if>  	
  	<if test="startTime != null">
  		and m.POSTTIME <![CDATA[>=]]>${startTime} 
  	</if>
  	<if test="endTime != null">
  		and m.POSTTIME <![CDATA[<=]]>${endTime}
  	</if>
  	<if test="admin == null or admin != 1">
			<choose>
				<when test="offers != null and offers.size() > 0">
					and m.office_id in
					<foreach collection="offers" open="(" close=")" separator="," item="offer">
						#{offer.id}
					</foreach>
				</when>
				<otherwise>
					and 1=2
				</otherwise>
			</choose>
		</if>
  	<if test="varyLat!=null and varyLat!='' and varyLon!=null and varyLon!='' and buffer!=null and buffer!=''">
  		and m.VARYLON+m.VARYVAT in (select m.VARYLON+m.VARYVAT from mo_meeting_info where sqrt(  
		    (  
		     ((#{varyLon}-m.VARYLON)*PI()*12656*COS(((#{varyLat}+m.VARYVAT)/2)*PI()/180)/180)  
		     *  
		     ((#{varyLon}-m.VARYLON)*PI()*12656*COS(((#{varyLat}+m.VARYVAT)/2)*PI()/180)/180)  
		    )  
		    +  
		    (  
		     ((#{varyLat}-m.VARYVAT)*PI()*12656/180)  
		     *  
		     ((#{varyLat}-m.VARYVAT)*PI()*12656/180)  
		    )  
		)<![CDATA[<]]>#{buffer})
  	</if>
  </select>
  <select id="getMeetingInfos" resultMap="meetingInfoMap">
  	select <include refid="meetingInfoColumns" />  	
  	from mo_meeting_info m  	
  	where 1 = 1
  	<if test="name!=null and name!=''">
			 and (m.NAME like concat('%',#{name},'%') or m.phone = #{name}) 			
    </if>
  	<if test="idCard != null and idCard != ''">
  		and m.id_card = #{idCard}
  	</if>
  	<if test="startTime != null">
  		and m.POSTTIME <![CDATA[>=]]>#{startTime}
  	</if>
  	<if test="endTime != null">
  		and m.POSTTIME <![CDATA[<=]]>#{endTime}
  	</if>
  	<if test="admin == null or admin != 1">
			<choose>
				<when test="offers != null and offers.size() > 0">
					and m.office_id in
					<foreach collection="offers" open="(" close=")" separator="," item="offer">
						#{offer.id}
					</foreach>
				</when>
				<otherwise>
					and 1=2
				</otherwise>
			</choose>
		</if>
  		<if test="varyLat!=null and varyLat!='' and varyLon!=null and varyLon!='' and buffer!=null and buffer!=''">
  		and m.VARYLON+m.VARYVAT in (select m.VARYLON+m.VARYVAT from mo_meeting_info where sqrt(  
		    (  
		     ((#{varyLon}-m.VARYLON)*PI()*12656*COS(((#{varyLat}+m.VARYVAT)/2)*PI()/180)/180)  
		     *  
		     ((#{varyLon}-m.VARYLON)*PI()*12656*COS(((#{varyLat}+m.VARYVAT)/2)*PI()/180)/180)  
		    )  
		    +  
		    (  
		     ((#{varyLat}-m.VARYVAT)*PI()*12656/180)  
		     *  
		     ((#{varyLat}-m.VARYVAT)*PI()*12656/180)  
		    )  
		)<![CDATA[<]]>#{buffer})
  	</if>
  	order by m.POSTTIME DESC
  </select>
  
  
  
  
  <select id="getMeetingInfoById" resultMap="meetingInfoMap">
  	select <include refid="meetingInfoColumns"></include>
  	from mo_meeting_info m
  	where m.id = #{id}
  	and 1 =1
  </select>
  <insert id="addMeetingInfo" >
    insert into mo_meeting_info (
    	<include refid="meetingInfoColumns2"></include>
    )
    values (#{id,jdbcType=VARCHAR}, #{bm,jdbcType=VARCHAR}, #{phone,jdbcType=VARCHAR}, 
      #{name,jdbcType=VARCHAR}, #{address,jdbcType=VARCHAR}, #{posttime,jdbcType=TIMESTAMP}, 
      #{varyvat,jdbcType=VARCHAR}, #{varylon,jdbcType=VARCHAR}, #{gemo,jdbcType=BINARY},#{idCard,jdbcType=VARCHAR},#{officeId,jdbcType=INTEGER}
      ,#{bname,jdbcType=VARCHAR}
      )
  </insert>
  <update id="updateMeetingInfo" >
    update mo_meeting_info
      set id = #{record.id,jdbcType=VARCHAR},
      bm = #{record.bm,jdbcType=VARCHAR},
      phone = #{record.phone,jdbcType=VARCHAR},
      name = #{record.name,jdbcType=VARCHAR},
      address = #{record.address,jdbcType=VARCHAR},
      posttime = #{record.posttime,jdbcType=TIMESTAMP},
      varyvat = #{record.varyvat,jdbcType=VARCHAR},
      varylon = #{record.varylon,jdbcType=VARCHAR},
      gemo = #{record.gemo,jdbcType=BINARY},
      idCard = #{record.idCard,jdbcType=VARCHAR},
      office_id = #{record.officeId,jdbcType=INTEGER},
      bname = #{record.bname,jdbcType=VARCHAR}
    where ID = #{id,jdbcType=VARCHAR}
  </update>
</mapper>