<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
	"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.aofa.sifa.mapper.sys.UserDao">
	<!-- 数据库连字符示例 <if test="dbName == 'oracle'">'%'||#{name}||'%'</if> <if test="dbName 
		== 'mssql'">'%'+#{name}+'%'</if> <if test="dbName == 'mysql'">concat('%',#{name},'%')</if> -->
	<sql id="userColumns">
		u.id,
		u.login_name,
		u.no,
		u.name,
		u.email,
		u.phone,
		u.mobile,
		u.user_type,
		u.login_ip,
		u.enabled,
		u.login_date,
		u.photo,
		u.creater_id,
		u.create_time,
		u.deleted,
		u.remarks,
		u.office_id,
		u.update_time,
		u.update_id
	</sql>
	<sql id="userColumns2">
		id,
		login_name,
		password,
		no,
		name,
		email,
		phone,
		mobile,
		user_type,
		login_ip,
		enabled,
		login_date,
		photo,
		creater_id,
		create_time,
		deleted,
		remarks,
		office_id,
		update_time,
		update_id
	</sql>
	<sql id="treeColumns">
		v.id as office_id,
		v.parent_id,
		v.name as office_name,
		v.deleted as office_deleted,
		v.enabled as office_enabled,
		v.code,
		v.sort,
		v.type,
		v.remarks as office_remarks,
		v.parent_ids,
		v.allow_group
	</sql>
	<resultMap type="Office" id="treeMap">
		<id column="office_id" property="id" />
		<result column="parent_id" property="parentId" />
		<result column="office_name" property="name" />
		<result column="code" property="code" />
		<result column="sort" property="sort" />
		<result column="type" property="type" />
		<result column="office_remarks" property="remarks" />
		<result column="parent_ids" property="parentIds" />
		<result column="allow_group" property="allowGroup" />
		<result column="office_deleted" property="deleted" />
		<result column="office_enabled" property="enabled" />
	</resultMap>
	<resultMap type="BaseBean" id="baseBean">
		<result column="creater_id" property="createrId" />
		<result column="create_time" property="createTime" />
		<result column="update_id" property="updateId" />
		<result column="update_time" property="updateTime" />
		<result property="deleted" column="deleted" />
		<result property="enabled" column="enabled" />
	</resultMap>
	<resultMap type="User" id="userMap" extends="baseBean">
		<id column="id" property="id" />
		<result property="loginName" column="login_name" />
		<result property="password" column="password" />
		<result property="no" column="no" />
		<result property="name" column="name" />
		<result property="email" column="email" />
		<result property="phone" column="phone" />
		<result property="mobile" column="mobile" />
		<result property="userType" column="user_type" />
		<result property="loginIp" column="login_ip" />
		<result property="loginDate" column="login_date" />
		<result property="photo" column="photo" />
		<result property="remarks" column="remarks" />
		<result property="officeId" column="office_id" />
		<association property="office" column="office_id"
			resultMap="treeMap"></association>
	</resultMap>

	<select id="getResultsByParam" resultMap="userMap">
		select
		<include refid="userColumns" />
		<if test="loadOffice == 'true'">
			,<include refid="treeColumns" />
		</if>
		from sys_user u
		<if test="loadOffice == 'true'">
			left join sys_office v on v.id = u.office_id and v.deleted = 1
		</if>
		 where u.deleted=1
		<if test="id !=null and id != ''">
			and u.id = #{id}
		</if>
		<if test="name != null and name != ''">
			and u.name like concat('%',#{name},'%')
		</if>
		<if test="loginName != null and loginName != ''">
			and u.login_name like concat('%',#{loginName},'%')
		</if>
		<if test="offerIds!=null and offerIds.size() != 0">
			or u.office_id in 
			<foreach collection="offerIds" item="offerId" open="(" close=")" separator=",">
				#{offerId}
			</foreach>
		</if>
		<if test="rows > 0">
			limit #{start},#{rows}
		</if>
	</select>

	<select id="getUserByOrder" resultMap="userMap">
		select
		<include refid="userColumns" />
		,
		<include refid="treeColumns" />
		from sys_user u
		left join sys_office v on v.id REGEXP
		concat('^(.*,)?',u.office_id,'(,(.*))?$') and v.deleted=1 and
		v.enabled=1
		where u.login_name = #{0} and u.password = #{1}
		and u.enabled=1 and u.deleted=1
	</select>
	<select id="getResultById" resultMap="userMap" parameterType="java.lang.String">
		select
		<include refid="userColumns" />
		from sys_user u
		left join sys_office v on v.id REGEXP
		concat('^(.*,)?',u.office_id,'(,(.*))?$') and v.deleted=1 and
		v.enabled=1
		where u.id=#{id}
		and u.enabled=1 and u.deleted=1
	</select>
	<select id="getUserByAccount" resultMap="userMap" parameterType="java.lang.String">
		select
		<include refid="userColumns" />
		from sys_user u
		<if test="loadOffice == 'true'">
			left join sys_office v on v.id REGEXP
			concat('^(.*,)?',u.office_id,'(,(.*))?$') and v.deleted=1 and
			v.enabled=1
		</if>
		where u.login_name=#{loginName}
		and u.enabled=1 and u.deleted=1
	</select>

	<select id="checkUser" resultMap="userMap">
		select
		<include refid="userColumns" />
		from sys_user u where u.deleted = 1
		<choose>
			<when
				test="(email != null and email != '') or (loginName != null and loginName != '') or (mobile != null and mobile != '')">
				and(
				<if test="email != null and email != ''">
					u.email = #{email}
				</if>
				<if test="loginName != null and loginName != ''">
					or u.login_name = #{loginName}
				</if>
				<if test="mobile != null and mobile != ''">
					or u.mobile = #{mobile}
				</if>
				)
			</when>
			<otherwise>
				and 1=2
			</otherwise>
		</choose>
	</select>


	<insert id="insert" parameterType="User">
		insert into sys_user (
		<include refid="userColumns2" />
		) values (
		#{id},
		#{loginName},
		#{password},
		#{no},
		#{name},
		#{email,jdbcType=VARCHAR},
		#{phone,jdbcType=VARCHAR},
		#{mobile,jdbcType=VARCHAR},
		#{userType},
		#{loginIp,jdbcType=VARCHAR},
		#{enabled},
		#{loginDate,jdbcType=TIMESTAMP},
		#{photo,jdbcType=VARCHAR},
		#{createrId,jdbcType=VARCHAR},
		#{createTime,jdbcType=TIMESTAMP},
		#{deleted},
		#{remarks},
		#{officeId},
		#{updateTime,jdbcType=TIMESTAMP},
		#{updateId}
		)
	</insert>
	<update id="update" parameterType="User">
		update sys_user set
		login_name=#{loginName},
		<if test="password != null and password != ''">
			password=#{password},
		</if>
		login_name=#{loginName},
		<!-- 工号是自动生成的，这里不再允许修改 -->
		<!-- no=#{no}, -->
		name=#{name},
		email=#{email,jdbcType=VARCHAR},
		phone=#{phone,jdbcType=VARCHAR},
		mobile=#{mobile,jdbcType=VARCHAR},
		user_type=#{userType},
		login_ip=#{loginIp,jdbcType=VARCHAR},
		enabled=#{enabled},
		login_date=#{loginDate,jdbcType=TIMESTAMP},
		photo=#{photo,jdbcType=VARCHAR},
		deleted=#{deleted},
		remarks=#{remarks},
		office_id=#{officeId},
		update_time=#{updateTime,jdbcType=TIMESTAMP},
		update_id=#{updateId}
		where id=#{id}
	</update>
	<update id="updateUserPassword">
		update sys_user set
		password=#{password}
		where id=#{id} and password=#{oldPassword}
	</update>
	<update id="deleteById" parameterType="java.lang.String">
		update sys_user u set
		u.deleted=0 where u.id=#{id}
	</update>
</mapper>
