<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
	"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.aofa.sifa.mapper.sys.OfficeDao">
	<sql id="treeColumns">
		v.id,
		v.parent_id,
		v.name,
		v.creater_id,
		v.create_time,
		v.deleted,
		v.enabled,
		v.code,
		v.sort,
		v.type,
		v.remarks,
		v.update_id,
		v.update_time,
		v.parent_ids,
		v.allow_group
	</sql>
	<sql id="treeColumns2">
		id,
		parent_id,
		name,
		creater_id,
		create_time,
		deleted,
		enabled,
		code,
		sort,
		type,
		remarks,
		update_id,
		update_time,
		parent_ids,
		allow_group
	</sql>
	<resultMap type="Office" id="treeMap" extends="baseBean">
		<id column="id" property="id"/>
		<result column="parent_id" property="parentId"/>
		<result column="name" property="name"/>
		<result column="code" property="code"/>
		<result column="sort" property="sort"/>
		<result column="type" property="type"/>
		<result column="remarks" property="remarks"/>
		<result column="parent_ids" property="parentIds"/>
		<result column="allow_group" property="allowGroup"/>
		<!-- 是否禁用当前节点 -->
		<result column="chk_disabled" property="chkDisabled"/>
		<result column="nocheck" property="nocheck"/>
	</resultMap>
  	<resultMap type="BaseBean" id="baseBean">
		<result column="creater_id" property="createrId"/>
		<result column="create_time" property="createTime"/>
		<result column="update_id" property="updateId"/>
		<result column="update_time" property="updateTime"/>
		<result property="deleted" column="deleted" />
		<result property="enabled" column="enabled" />
	</resultMap>
    
    <select id="getAllOffices" resultMap="treeMap">
    	select 
    		<include refid="treeColumns"></include>
    		<if test="checkDisable == 'true' and roleId != null">
    			,(case when (o.office_id=v.id and o.role_id!=#{roleId}) then 1 else 0 end) as chk_disabled
    		</if>
    	from sys_office v
    	where v.deleted=1
    	<if test="enabled != -1">
    		and v.enabled = #{enabled}
    	</if>
    	<if test="showLast !=null and showLast == 0">
    		and v.allow_group = 1
    	</if>
    	order by v.parent_id asc,case when isnull(v.sort) then 1 else 0 end asc,v.sort asc
    </select>
    
    <select id="getOfficeChildren" resultMap="treeMap" parameterType="java.lang.Integer">
		SELECT
		 <include refid="treeColumns"/>
		FROM sys_office v where v.id!=#{id} and v.parent_ids REGEXP concat('^(.*,)?',#{id},'(,(.*))?$') and v.deleted=1
		order by v.parent_id asc,case when isnull(v.sort) then 1 else 0 end asc,v.sort asc
	</select>
	
	<select id="getOfficeChildrenAndParent" resultMap="treeMap">
		SELECT
		 <include refid="treeColumns"/>
		FROM sys_office v where ( v.id= #{id} or v.parent_ids REGEXP concat('^(.*,)?',#{id},'(,(.*))?$') or (select v.parent_ids from sys_office v where v.id = #{id} ) REGEXP( concat('^(.*,)?',v.id,'(,(.*))?$') ) )and v.deleted=1
		order by v.parent_id asc,case when isnull(v.sort) then 1 else 0 end asc,v.sort asc
	</select>
    <select id="getOfficeParent" resultMap="treeMap">
		SELECT
		 <include refid="treeColumns"/>
		FROM sys_office v 
		where v.id !=  #{id} and (select parent_ids from sys_office where id=  #{id}) REGEXP concat('^(.*,)?',v.id,'(,(.*))?$') and v.deleted=1
		order by v.parent_id asc,case when isnull(v.sort) then 1 else 0 end asc,v.sort asc;
    </select>
    
    <select id="getOfficeById" resultMap="treeMap" >
    	select 
    		<include refid="treeColumns"></include>
    	from sys_office v
    	where v.id=#{id} and v.deleted=1
    </select>
    
     <select id="getOfficeByName" resultMap="treeMap" >
    	select 
    		<include refid="treeColumns"></include>
    	from sys_office v
    	where v.name=#{name} and v.deleted=1
    </select>
    
    <select id="getLastOffice" resultMap="treeMap">
    	select 
    		<include refid="treeColumns"></include>
    	from sys_office v
    	where v.deleted=1 and v.allow_group = 0
    	<if test="enabled != -1">
    		and v.enabled = #{enabled}
    	</if>
    </select>
    
    <select id="getOfficeByCode" resultMap="treeMap">
    	select
    		<include refid="treeColumns"></include>
    	from sys_office v
    	where v.code = #{code} and v.deleted = 1
    </select>
    
    <insert id="addOffice" useGeneratedKeys="true" keyProperty="id">
    	insert into sys_office(
    		<include refid="treeColumns2"></include>
    	)values(
    		#{id},
			#{parentId},
			#{name},
			#{createrId},
			#{createTime},
			#{deleted},
			#{enabled},
			#{code},
			#{sort},
			#{type},
			#{remarks},
			#{updateId},
			#{updateTime},
			#{parentIds},
			#{allowGroup}
    	)
    </insert>
    <update id="updateOffice">
    	update sys_office set
			parent_id=#{parentId},
			name=#{name},
			deleted=#{deleted},
			enabled=#{enabled},
			<!-- 机构编号自动生成，不允许修改 -->
			<!-- code=#{code}, -->
			sort=#{sort},
			type=#{type},
			remarks=#{remarks},
			update_id=#{updateId},
			update_time=#{updateTime},
			parent_ids=#{parentIds},
			allow_group=#{allowGroup}
		where id=#{id}
    </update>
    <update id="deleteOffice">
    	update sys_office set deleted=0 where id=#{id}
    </update>
</mapper>