<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.aofa.sifa.mapper.supervision.LeaveDao">
	<resultMap id="leaveMap" type="Leave">
		<id column="id" jdbcType="VARCHAR" property="id" />
		<result column="prisoner_id" jdbcType="VARCHAR" property="prisonerId" />
		<result column="begin_time" jdbcType="TIMESTAMP" property="beginTime" />
		<result column="end_time" jdbcType="TIMESTAMP" property="endTime" />
		<result column="status" jdbcType="SMALLINT" property="status" />
		<result column="creater_id" jdbcType="VARCHAR" property="createrId" />
		<result column="create_time" jdbcType="TIMESTAMP" property="createTime" />
		<result column="name" jdbcType="VARCHAR" property="name" />
		<result column="phone" jdbcType="VARCHAR" property="phone" />
		<result column="creater_name" jdbcType="VARCHAR" property="createrName" />
		<result column="office_id" jdbcType="INTEGER" property="officeId" />
		<result column="office_name" jdbcType="VARCHAR" property="officeName" />
	</resultMap>
	<sql id="leaveColumns">
		l.id, l.prisoner_id, l.begin_time, l.end_time, l.status, l.creater_id,
		l.create_time,l.office_id,l.office_name
	</sql>
	<sql id="leaveColumns2">
		id, prisoner_id, begin_time, end_time, status, creater_id, create_time,office_id,office_name
	</sql>
	<select id="getLeaves" resultMap="leaveMap">
		select
		<include refid="leaveColumns"></include>,p.name,p.phone,u.name as creater_name
		from mo_leave l
		left join fm_drugster p on p.id = l.prisoner_id
		left join sys_user u on u.id = l.creater_id
		where 1=1
		<if test="name != null and name != ''">
			and p.name like concat('%',#{name},'%')
		</if>
		<if test="admin == null or admin != 1">
		<choose>
			<when test="offices == null or offices.size() == 0">
				and 1=2
			</when>
			<otherwise>
				and l.office_id in
				<foreach collection="offices" open="(" close=")" item="office" separator=",">
					#{office.id}
				</foreach>
			</otherwise>
		</choose>
  	</if>
		<if test="rows > 0">
			limit #{start}, #{rows}
		</if>
	</select>
	<select id="getCount" resultType="java.lang.Long">
		select
		 count(id)
		<if test="name != null and name != ''">
			,p.name,p.phone,u.name as creater_name
		</if>
		
		from mo_leave l
		where 1=1
		<if test="name != null and name != ''">
			left join fm_prisoner p on p.id = l.prisoner_id
			and p.name like concat('%',#{name},'%')
		</if>
		<if test="admin == null or admin != 1">
		<choose>
			<when test="offices == null or offices.size() == 0">
				and 1=2
			</when>
			<otherwise>
				and l.office_id in
				<foreach collection="offices" open="(" close=")" item="office" separator=",">
					#{office.id}
				</foreach>
			</otherwise>
		</choose>
  	</if>
	</select>
	<select id="getLeaveById" resultMap="leaveMap">
		select <include refid="leaveColumns"></include>,p.name,p.phone,u.name as creater_name
		from mo_leave l
		left join fm_prisoner p on p.id = l.prisoner_id
		left join sys_user u on u.id = l.creater_id
		where l.id = #{id}
	</select>
	<select id="checkIsLeave" resultType="java.lang.Long">
		select 
			count(l.id)
		from mo_leave l where (#{date} <![CDATA[>=]]> STR_TO_DATE(DATE_FORMAT(l.begin_time,'%Y-%m-%d'),'%Y-%m-%d') and #{date} <![CDATA[<=]]> STR_TO_DATE(concat(DATE_FORMAT(l.end_time,'%Y-%m-%d'),' 23:59:59'),'%Y-%m-%d %H:%i:%s') ) and l.prisoner_id = #{prisonerId}
	</select>
	<insert id="addLeave">
		insert into mo_leave (
			<include refid="leaveColumns2"></include>
		)
		values (#{id,jdbcType=VARCHAR}, #{prisonerId,jdbcType=VARCHAR},
		#{beginTime,jdbcType=TIMESTAMP},
		#{endTime,jdbcType=TIMESTAMP}, #{status,jdbcType=SMALLINT}, #{createrId,jdbcType=VARCHAR},
		#{createTime,jdbcType=TIMESTAMP},
		 #{officeId,jdbcType=INTEGER}, #{officeName,jdbcType=VARCHAR})
	</insert>
	<update id="updateLeave">
		update mo_leave
		set prisoner_id = #{prisonerId,jdbcType=VARCHAR},
		begin_time = #{beginTime,jdbcType=TIMESTAMP},
		end_time = #{endTime,jdbcType=TIMESTAMP},
		status = #{status,jdbcType=SMALLINT},
		creater_id = #{createrId,jdbcType=VARCHAR},
		create_time = #{createTime,jdbcType=TIMESTAMP},
		  office_id=#{officeId,jdbcType=INTEGER},
	      office_name=#{officeName,jdbcType=VARCHAR}
		where id = #{id,jdbcType=VARCHAR}
	</update>
</mapper>