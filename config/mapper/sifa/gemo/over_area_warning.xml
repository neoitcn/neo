<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.aofa.sifa.mapper.gemo.OverAreaWarningDao">
	<sql id="overAreaWarningColumns">
		oa.id, oa.varylon, oa.varylat, oa.varyname, oa.varytel,
		oa.varyaddr, oa.varytime, oa.warning_device,
		oa.message_open,oa.geom,oa.order_area,oa.id_card,oa.order_type,oa.is_handler,oa.office_id,oa.remarks,oa.drugster_id
	</sql>
	<sql id="overAreaWarningColumns2">
		id, varylon, varylat, varyname, varytel, varyaddr,
		varytime, warning_device,
		message_open,geom,order_area,id_card,order_type,is_handler,office_id,remarks,drugster_id
	</sql>
	<sql id="treeColumns">
		v.id tree_id,
		v.parent_id,
		v.name tree_name,
		v.code tree_code,
		v.sort tree_sort,
		v.type tree_type,
		v.remarks tree_remarks,
		v.parent_ids
	</sql>
	<sql id="historyInfoColumns">
		h.ID as H_ID, h.SJH, h.NAME, h.ADDRESS, h.STATE,
		h.XML_INFO,
		h.POSTTIME,
		h.USERNAME, h.ISGET, h.QYBS, h.DEVICENO,
		h.SPEED, h.DIRECT,
		h.POSTAREA, h.ISTEMP, h.DELETED, h.VARYLON as
		H_VARYLON, h.VARYLAT as H_VARYLAT,
		h.JZJGBM,
		h.DWTYPE,h.POINT, h.GEOM as
		H_GEOM
	</sql>
	<resultMap id="overAreaWarningMap" type="OverAreaWarning">
		<id column="id" jdbcType="VARCHAR" property="id" />
		<result column="varylon" jdbcType="VARCHAR" property="varylon" />
		<result column="varylat" jdbcType="VARCHAR" property="varylat" />
		<result column="varyname" jdbcType="VARCHAR" property="varyname" />
		<result column="varytel" jdbcType="VARCHAR" property="varytel" />
		<result column="varyaddr" jdbcType="VARCHAR" property="varyaddr" />
		<result column="varytime" jdbcType="TIMESTAMP" property="varytime" />
		<result column="warning_device" jdbcType="INTEGER" property="warningDevice" />
		<result column="message_open" jdbcType="INTEGER" property="messageOpen" />
		<result column="geom" jdbcType="BINARY" property="geom" />
		<result column="order_area" jdbcType="VARCHAR" property="orderArea" />
		<result column="order_type" jdbcType="INTEGER" property="orderType" />
		<result column="is_handler" jdbcType="INTEGER" property="isHandler" />
		<result column="id_card" jdbcType="VARCHAR" property="idCard" />
		<result column="drugster_id" jdbcType="VARCHAR" property="drugsterId" />
		<result column="office_id" jdbcType="INTEGER" property="officeId" />
		<result column="remarks" jdbcType="VARCHAR" property="remarks" />
		<result column="officename" jdbcType="VARCHAR" property="officename"/>
		<result column="drugsterTimes" jdbcType="VARCHAR" property="drugsterTimes"/>
		<association property="currOffice" resultMap="treeMap"></association>
	</resultMap>
	<resultMap id="treeMap" type="Office">
		<id column="tree_id" property="id" />
		<result column="parent_id" property="parentId" />
		<result column="tree_name" property="name" />
		<result column="tree_code" property="code" />
		<result column="tree_sort" property="sort" />
		<result column="tree_type" property="type" />
		<result column="tree_remarks" property="remarks" />
		<result column="parent_ids" property="parentIds" />
	</resultMap>
	<resultMap id="historyInfoMap" type="HistoryInfo">
		<id column="H_ID" jdbcType="VARCHAR" property="id" />
		<result column="SJH" jdbcType="VARCHAR" property="sjh" />
		<result column="NAME" jdbcType="VARCHAR" property="name" />
		<result column="ADDRESS" jdbcType="VARCHAR" property="address" />
		<result column="STATE" jdbcType="VARCHAR" property="state" />
		<result column="XML_INFO" jdbcType="VARCHAR" property="xmlInfo" />
		<result column="POSTTIME" jdbcType="TIMESTAMP" property="posttime" />
		<result column="USERNAME" jdbcType="VARCHAR" property="username" />
		<result column="ISGET" jdbcType="BIT" property="isget" />
		<result column="QYBS" jdbcType="VARCHAR" property="qybs" />
		<result column="DEVICENO" jdbcType="VARCHAR" property="deviceno" />
		<result column="SPEED" jdbcType="VARCHAR" property="speed" />
		<result column="DIRECT" jdbcType="VARCHAR" property="direct" />
		<result column="POSTAREA" jdbcType="VARCHAR" property="postarea" />
		<result column="ISTEMP" jdbcType="BIT" property="istemp" />
		<result column="DELETED" jdbcType="INTEGER" property="deleted" />
		<result column="H_VARYLON" jdbcType="VARCHAR" property="varylon" />
		<result column="H_VARYLAT" jdbcType="VARCHAR" property="varylat" />
		<result column="JZJGBM" jdbcType="VARCHAR" property="jzjgbm" />
		<result column="DWTYPE" jdbcType="VARCHAR" property="dwtype" />
		<result column="POINT" jdbcType="BINARY" property="point" />
		<result column="H_GEOM" jdbcType="BINARY" property="geom" />
	</resultMap>
	<select id="getOverAreaWarnings" resultMap="overAreaWarningMap">
		select
		<include refid="overAreaWarningColumns"></include>
		,
		<include refid="treeColumns"></include>
		,v.name as officename
		from mo_over_area_warning oa
		left join sys_office v on v.id = oa.office_id and
		v.enabled = 1 and v.deleted = 1
		where 1=1
		<if test="name != null and name != ''">
			and ( oa.varyname like concat('%',#{name},'%') or
			oa.varytel like concat('%',#{name},'%') )
		</if>
		<if test="state != null">
			and oa.is_handler = #{state}
		</if>
		<if test="startTime != null">
			and oa.varytime <![CDATA[>=]]>
			#{startTime}
		</if>
		<if test="endTime != null">
			and oa.varytime <![CDATA[<=]]>
			#{endTime}
		</if>
		<if test="time != null and time != ''">
			AND
			oa.varytime <![CDATA[>=]]>#{time}
			AND
			oa.varytime <![CDATA[<=]]>concat(#{time},'
			23:59:59') 
		</if>
		<choose>
			<when test="admin==null or admin!=1">
				<if test="offices!=null and offices.size>0">
					and oa.office_id IN
					<foreach collection="offices" open="(" close=")" separator="," item="office">
						#{office.id}
					</foreach>
				</if>
			</when>
			<otherwise>
				and 1=2
			</otherwise>
		</choose>
		order by oa.varytime desc
		<if test="rows > 0">
			limit #{start}, #{rows}
		</if>
	</select>
	<select id="getHistoryOverAreaWarnings" resultMap="overAreaWarningMap">
		select
		<include refid="overAreaWarningColumns"></include>
		,
		from mo_over_area_warning oa
		<if test="startTime != null and endTime != null">
			where (#{startTime} <![CDATA[<=]]>
			oa.varytime and #{endTime} <![CDATA[>=]]>
			oa.varytime )
		</if>
		<if test="startTime == null or endTime == null">
			where 1=2
		</if>
	</select>
	<!-- <select id="getOverAreaWarningsForWarningTable"> </select> -->
	<select id="getCount" resultType="java.lang.Long">
		select
		count(oa.id)
		from mo_over_area_warning oa where 1=1
		<if test="name != null and name != ''">
			and ( oa.varyname like concat('%',#{name},'%') or
			oa.varytel like concat('%',#{name},'%') )
		</if>
		<if test="state != null">
			and oa.is_handler = #{state}
		</if>
		<if test="startTime != null">
			and oa.varytime <![CDATA[>=]]>
			#{startTime}
		</if>
		<if test="endTime != null">
			and oa.varytime <![CDATA[<=]]>
			#{endTime}
		</if>
		<if test="time != null and time != ''">
			AND
			oa.varytime <![CDATA[>=]]>#{time}
			AND
			oa.varytime <![CDATA[<=]]>concat(#{time},'
			23:59:59')
		</if>
		<choose>
			<when test="admin==null or admin!=1">
				<if test="offices!=null and offices.size>0">
					and oa.office_id IN
					<foreach collection="offices" open="(" close=")" separator="," item="office">
						#{office.id}
					</foreach>
				</if>
			</when>
			<otherwise>
				and 1=2
			</otherwise>
		</choose>
	</select>
	<select id="getOverAreaWarningById" resultMap="overAreaWarningMap">
		select
		<include refid="overAreaWarningColumns"></include>
		,
		<include refid="historyInfoColumns"></include>
		from mo_over_area_warning oa
		left join mo_history_info h on h.VARYLON =
		oa.varylon and h.VARYLAT = oa.varylat and h.SJH = oa.varytel and
		h.DELETED = 1
		where oa.id=#{id}
	</select>
	<select id="searchForRpt" resultMap="overAreaWarningMap">
		select r.office_id,o.name as officename,r.id,count(r.id) as drugsterTimes from mo_over_area_warning r
		left join sys_office o on o.id=r.office_id
		where 1=1
		<if test="startDate != null">
			and r.varytime <![CDATA[>=]]> #{startDate}
		</if>
		<if test="endDate != null">
			and r.varytime <![CDATA[<=]]> #{endDate}
		</if>
		group by r.drugster_id
	</select>
	<insert id="addOverAreaWarning">
		insert into mo_over_area_warning (
		<include refid="overAreaWarningColumns2"></include>
		)
		values (#{id,jdbcType=VARCHAR}, #{varylon,jdbcType=VARCHAR},
		#{varylat,jdbcType=VARCHAR},
		#{varyname,jdbcType=VARCHAR},
		#{varytel,jdbcType=VARCHAR}, #{varyaddr,jdbcType=VARCHAR},
		#{varytime,jdbcType=TIMESTAMP}, #{warningDevice,jdbcType=INTEGER},
		#{messageOpen,jdbcType=INTEGER},
		#{geom,jdbcType=BINARY},
		#{orderArea,jdbcType=VARCHAR},
		#{idCard},#{orderType},#{isHandler},#{officeId},#{remarks},#{drugsterId})
	</insert>
	<update id="updateOverAreaWarning">
		update mo_over_area_warning
		set
		varylon =
		#{varylon,jdbcType=VARCHAR},
		varylat =
		#{varylat,jdbcType=VARCHAR},
		varyname =
		#{varyname,jdbcType=VARCHAR},
		varytel =
		#{varytel,jdbcType=VARCHAR},
		varyaddr =
		#{varyaddr,jdbcType=VARCHAR},
		varytime =
		#{varytime,jdbcType=TIMESTAMP},
		warning_device =
		#{warningDevice,jdbcType=INTEGER},
		message_open =
		#{messageOpen,jdbcType=INTEGER},
		geom=#{geom,jdbcType=BINARY},
		order_area=#{orderArea,jdbcType=VARCHAR},
		id_card=#{idCard},
		order_type=#{orderType},
		is_handler=#{isHandler},
		office_id=#{officeId},
		remarks=#{remarks},
		drugster_id=#{drugsterId}
		where id=#{id}
	</update>
</mapper>