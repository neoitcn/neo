<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.aofa.sifa.mapper.gemo.SkHistoryDao">
  <resultMap id="skHistoryMap" type="SkHistory">
    <id column="id" jdbcType="VARCHAR" property="id" />
    <result column="imei" jdbcType="VARCHAR" property="imei" />
    <result column="pid" jdbcType="VARCHAR" property="pid" />
    <result column="time" jdbcType="TIMESTAMP" property="time" />
    <result column="phone" jdbcType="VARCHAR" property="phone" />
    <result column="isdelete" jdbcType="BIT" property="isdelete" />
    <result column="isjj" jdbcType="VARCHAR" property="isjj" />
    <result column="lon" jdbcType="VARCHAR" property="lon" />
    <result column="lat" jdbcType="VARCHAR" property="lat" />
    <result column="dwzt" jdbcType="VARCHAR" property="dwzt" />
    <result column="lacid" jdbcType="VARCHAR" property="lacid" />
    <result column="cid" jdbcType="VARCHAR" property="cid" />
    <result column="address" jdbcType="VARCHAR" property="address" />
    <result column="dwtype" jdbcType="VARCHAR" property="dwtype" />
    <result column="zxh" jdbcType="VARCHAR" property="zxh" />
    <result column="zxhm" jdbcType="VARCHAR" property="zxhm" />
    <result column="lsh" jdbcType="VARCHAR" property="lsh" />
    <result column="yj_type" jdbcType="VARCHAR" property="yjType" />
    <result column="wddk_warning" jdbcType="VARCHAR" property="wddkWarning" />
    <result column="rfdk_warning" jdbcType="VARCHAR" property="rfdkWarning" />
    <result column="phone_power" jdbcType="VARCHAR" property="phonePower" />
    <result column="witch_power" jdbcType="VARCHAR" property="witchPower" />
  </resultMap>

  <sql id="skHistoryColumn">
    id, imei, pid, time, phone, isdelete, isjj, lon, lat, dwzt, lacid, cid, address, 
    dwtype, zxh, zxhm, lsh, yj_type, wddk_warning, rfdk_warning, phone_power, witch_power
  </sql>

  <select id="searchLastByImei" resultMap="skHistoryMap">
    select
      <include refid="skHistoryColumn"/>
    from smu_pin_history where
    <choose>
      <when test="imeis != null and imeis.size() > 0">
        imei IN
        <foreach collection="imeis" open="(" close=")" separator="," item="imei">
          #{imei}
        </foreach>
      </when>
      <otherwise>
        1=2
      </otherwise>

    </choose>
  </select>
  <!--分组查询手铐最后一条定位数据，暂时没用上 by huangjj-->
  <select id="searchLastByImeiNew" resultMap="skHistoryMap">
    select
    <include refid="skHistoryColumn"/>
    from smu_pin_history where
    TIME=(SELECT MAX(TIME) FROM smu_pin_history a WHERE a.imei=smu_pin_history.imei);
  </select>
  <!--分组查询手铐最后一条定位数据,目前用的是这个 by shisan-->
  <select id="searchLastByImeiByShisan" resultMap="skHistoryMap">
    SELECT <include refid="skHistoryColumn"/>
    FROM smu_pin_history smout,(
    SELECT
      sm.imei,MAX(sm.time) AS maxTime
    FROM smu_pin_history sm
    GROUP BY sm.imei) inn WHERE inn.maxTime = smout.time and inn.imei = smout.imei
    <choose>
      <when test="imeis != null and imeis.size() > 0">
        and smout.imei IN
        <foreach collection="imeis" open="(" close=")" separator="," item="imei">
          #{imei}
        </foreach>
      </when>
      <otherwise>
        1=2
      </otherwise>

    </choose>
    group by smout.imei
  </select>
  <select id="getskHistoryInfos" resultMap="skHistoryMap">
    select <include refid="skHistoryColumn" />
    <if test="needOfficeName == 'true'">
      ,o.name as officeName
    </if>
    from smu_pin_history h
    <!--<if test="needOfficeName == 'true'">-->
      <!--left join sys_office o on h.office_id = o.id and o.deleted = 1-->
    <!--</if>-->
    where h.isdelete = '0'
    <if test="imei!=null and imei!=''">
      and h.imei like concat('%',#{imei},'%')
    </if>
    <if test="name!=null and name!=''">
      and (h.NAME like concat('%',#{name},'%') or h.phone = #{name})
    </if>
    <if test="startTime != null">
      and h.TIME <![CDATA[>=]]> #{startTime}
    </if>
    <if test="endTime != null">
      and h.TIME <![CDATA[<=]]> #{endTime}
    </if>
    <!--<if test="admin == null or admin != 1">-->
      <!--<choose>-->
        <!--<when test="offices == null or offices.size() == 0">-->
          <!--and 1=2-->
        <!--</when>-->
        <!--<otherwise>-->
          <!--and h.office_id in-->
          <!--<foreach collection="offices" open="(" close=")" item="office" separator=",">-->
            <!--#{office.id}-->
          <!--</foreach>-->
        <!--</otherwise>-->
      <!--</choose>-->
    <!--</if>-->
    order by h.TIME DESC
  </select>
  <!--<insert id="insert" parameterType="com.aofa.sifa.entity.SmuPinHistory">
    insert into smu_pin_history (id, imei, pid, 
      time, phone, isdelete, 
      isjj, lon, lat, dwzt, 
      lacid, cid, address, 
      dwtype, zxh, zxhm, 
      lsh, yj_type, wddk_warning, 
      rfdk_warning, phone_power, witch_power
      )
    values (#{id,jdbcType=VARCHAR}, #{imei,jdbcType=VARCHAR}, #{pid,jdbcType=VARCHAR}, 
      #{time,jdbcType=TIMESTAMP}, #{phone,jdbcType=VARCHAR}, #{isdelete,jdbcType=BIT}, 
      #{isjj,jdbcType=VARCHAR}, #{lon,jdbcType=VARCHAR}, #{lat,jdbcType=VARCHAR}, #{dwzt,jdbcType=VARCHAR}, 
      #{lacid,jdbcType=VARCHAR}, #{cid,jdbcType=VARCHAR}, #{address,jdbcType=VARCHAR}, 
      #{dwtype,jdbcType=VARCHAR}, #{zxh,jdbcType=VARCHAR}, #{zxhm,jdbcType=VARCHAR}, 
      #{lsh,jdbcType=VARCHAR}, #{yjType,jdbcType=VARCHAR}, #{wddkWarning,jdbcType=VARCHAR}, 
      #{rfdkWarning,jdbcType=VARCHAR}, #{phonePower,jdbcType=VARCHAR}, #{witchPower,jdbcType=VARCHAR}
      )
  </insert>
  <update id="updateByPrimaryKey" parameterType="com.aofa.sifa.entity.SmuPinHistory">
    update smu_pin_history
    set imei = #{imei,jdbcType=VARCHAR},
      pid = #{pid,jdbcType=VARCHAR},
      time = #{time,jdbcType=TIMESTAMP},
      phone = #{phone,jdbcType=VARCHAR},
      isdelete = #{isdelete,jdbcType=BIT},
      isjj = #{isjj,jdbcType=VARCHAR},
      lon = #{lon,jdbcType=VARCHAR},
      lat = #{lat,jdbcType=VARCHAR},
      dwzt = #{dwzt,jdbcType=VARCHAR},
      lacid = #{lacid,jdbcType=VARCHAR},
      cid = #{cid,jdbcType=VARCHAR},
      address = #{address,jdbcType=VARCHAR},
      dwtype = #{dwtype,jdbcType=VARCHAR},
      zxh = #{zxh,jdbcType=VARCHAR},
      zxhm = #{zxhm,jdbcType=VARCHAR},
      lsh = #{lsh,jdbcType=VARCHAR},
      yj_type = #{yjType,jdbcType=VARCHAR},
      wddk_warning = #{wddkWarning,jdbcType=VARCHAR},
      rfdk_warning = #{rfdkWarning,jdbcType=VARCHAR},
      phone_power = #{phonePower,jdbcType=VARCHAR},
      witch_power = #{witchPower,jdbcType=VARCHAR}
    where id = #{id,jdbcType=VARCHAR}
  </update>-->
</mapper>